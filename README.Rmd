---
title: "rlpi package"
author: "Robin Freeman, IoZ, Zoological Society of London"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---
##Using the rlpi package 

### Overview

The current **rlpi** package works with csv source data where each row is composed 
of **popid**, **speciesname**, **year**, **popvalue** (see below). These can be in multiple groups (files), and an 'infile' tells the package where these groups/files are. If you're constructing an index for a single group, you would have a single data file and a single
infile which points to that data file (see first example below). For multiple groups, the infile would refer to all relevant datafiles and can specify weightings (to allow for weighting by taxonomic, spatial distribution, etc).

The example given below includes an example dataset for terrestrial vertebrates
with a complex infile with multiple weighted groups and a simple infile for Nearctic mammals

At present the code combines population time-series to the species level, generating
an average index for each species, then combines these into the groups. If you don't wish
to combine to the species level, then the 'speciesname' column will need to be unique for
each population (for example, by concatenating the speciesname and popid columns)

### Using the package 

First, install the devtools package to enable installing from github

```{r rlpi_install, eval=FALSE}
install.packages("devtools")
library(devtools)

# Install from main ZSL repository online
install_github("Zoological-Society-of-London/rlpi", auth_token = "3e95e9d1c26c0bd8f9fed628b224dbe811064c20")
# Load library
library(rlpi)


# Get example data from package
# Copy zipped data to local directory 
file.copy(from=system.file("extdata", "example_data.zip", package = "rlpi"), to=getwd())
# Extract data, this will create a directory of terrestrial LPI data to construct a terrestrial index from.
unzip("example_data.zip")

```

Within the example data are a number of 'infiles', these files (take a look at them!) contain links to other files arranged into groups and including weightings. 

For example **terrestrial_class_nearctic_infile.txt** which constructs and index for a single group contains:

```
"FileName"	"Group"	"Weighting"
"class_realms/terrestrial_lpi_rc_p1970_Nearctic_Mammalia.txt"	1	0.175804093567251
```

This references a single 'population' data file (the raw data) in the **class_realms** folder  which in this case contains population counts for Neartic mammals (again, have a a look), in this format:

first six lines of **class_realms/terrestrial_lpi_rc_p1970_Nearctic_Mammalia.txt**:

```
Binomial	ID	year	popvalue
Ovis_canadensis	4618	1950	390
Ovis_canadensis	5328	1950	1500
Myodes_gapperi	4560	1952	17
Sorex_cinereus	4587	1952	3
Napaeozapus_insignis	4588	1952	18
...
```

Using these files to contruct a Neartic index can be done as follows:

```{r nearctic_lpi, eval=FALSE}
# Make a Neactic LPI 
# Default gives 100 boostraps (this takes a couple of minutes to run on a 2014 Macbook)
Nearc_lpi <- LPIMain("terrestrial_class_nearctic_infile.txt", use_weightings = 1)

# That should have produced a simple plot, but we can use ggplot_lpi to produce a nicer one
ggplot_lpi(Nearc_lpi, ylims=c(0, 2))

# Make a Neactic Mammals LPI 
# Default gives 100 boostraps (this will take a few minutes to run (on a 2014 Macbook))
Nearc_mams_lpi <- LPIMain("terrestrial_mammals_nearctic_infile.txt")

# Nicer plot
ggplot_lpi(Nearc_mams_lpi, ylims=c(0, 2))

# Make a Neactic Mammals LPI 
# Default gives 100 boostraps (this will take a few minutes to run (on a 2014 Macbook))
Nearc_birds_lpi <- LPIMain("terrestrial_birds_nearctic_infile.txt")

# Nicer plot
ggplot_lpi(Nearc_birds_lpi, ylims=c(0, 2))

# Putting the two LPIs together in a list
lpis <- list(Nearc_birds_lpi, Nearc_mams_lpi)
# And plotting them together should show identical means but with different CIs
ggplot_multi_lpi(lpis, xlims=c(1970, 2012), ylims=c(0, 3))

# Can also plot these next to each other, and use some more meaningful titles
ggplot_multi_lpi(lpis, names=c("Birds", "Mammals"), xlims=c(1970, 2012), ylims=c(0, 3), facet=TRUE)

```

```{r terrestrial_lpi, eval=FALSE}
# Whole terrestrial...

# Run same again, but used cached lambdas (force_recalculation == 0), and now weighted by class, but equal across realms (see infile for weights)
terr_lpi_a <- LPIMain("terrestrial_class_realms_infile.txt", use_weightings=0)

# Run same again, but used cached lambdas (force_recalculation == 0), and now weighted by class, but equal across realms (see infile for weights)
  terr_lpi_b <- LPIMain("terrestrial_class_realms_infile.txt", force_recalculation=0, use_weightings=1)

# Putting the two LPIs together in a list
lpis_comp <- list(terr_lpi_a, terr_lpi_b)
# And plotting them together should show identical means but with different CIs
ggplot_multi_lpi(lpis_comp, xlims=c(1970, 2012))
ggplot_multi_lpi(lpis_comp, xlims=c(1970, 2012), names=c("Unweighted", "Weighted"), facet=TRUE)
```

```{r making_infiles, eval=FALSE}
# Constructing infiles from the populations table...
#
lpi_data <- read.csv("example_pops.csv", na.strings = "NULL")

example_infile_name <- create_infile(lpi_data, name="example_data")
example_lpi <- LPIMain(example_infile_name, REF_YEAR = 1970, PLOT_MAX = 2014, BOOT_STRAP_SIZE = 100)
ggplot_lpi(example_lpi, title = "example_lpi", xlims=c(1970, 2012), ylim=c(0.5, 2), trans="log")

Strigiformes = lpi_data$Order == "Strigiformes" 
s_infile_name <- create_infile(lpi_data, index_vector=Strigiformes, name="example_data")
s_lpi <- LPIMain(s_infile_name, REF_YEAR = 1970, PLOT_MAX = 2014, BOOT_STRAP_SIZE = 100)
ggplot_lpi(s_lpi, title = "s_lpi", xlims=c(1970, 2012), ylim=c(0.5, 2), trans="log")


Passeriformes = lpi_data$Order == "Passeriformes" 
p_infile_name <- create_infile(lpi_data, index_vector=Passeriformes, name="example_data")
p_lpi <- LPIMain(s_infile_name, REF_YEAR = 1970, PLOT_MAX = 2014, BOOT_STRAP_SIZE = 100)
ggplot_lpi(p_lpi, title = "p_lpi", xlims=c(1970, 2012), ylim=c(0.5, 2), trans="log")
```



```{r lambda_plots, eval=FALSE}

# Part 3
# Population level lambdas (_PopLambda.txt)
#** NOTE that na.strings is "-1" here to make these NA values
pop_lambda_data <- read.table("example_data_pops_PopLambda.txt", header = TRUE, sep=",", na.strings = "-1")

pop_lambda_values <- pop_lambda_data[, 2:ncol(pop_lambda_data)]
ggplot_lambdas(pop_lambda_values, baseline=1, ylims=c(0.8, 1.2), xlims=c(1970, 2014.5))

# Species level lambdas (_lambda.txt) 
#** NOTE that na.strings is "NA" here to make these NA values
sp_lambda_data <- read.table("example_data_pops_lambda.txt", header = TRUE, sep=",", na.strings = "NA")

sp_lambda_values <- sp_lambda_data[, 2:ncol(sp_lambda_data)]
ggplot_lambdas(sp_lambda_values, baseline=1, ylims=c(0.8, 1.2), xlims=c(1970, 2014.5))

```
